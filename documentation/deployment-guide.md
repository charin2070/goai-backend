# Инструкция: Когда необходимо перезагружать сервер разработки

В современной веб-разработке, особенно при использовании фреймворков вроде Next.js, существует Hot Module Replacement (HMR) — технология, которая позволяет применять изменения в коде "на лету", без полной перезагрузки сервера. Это значительно ускоряет процесс.

Однако HMR не всесилен. Существуют ситуации, когда ручная перезагрузка сервера (`pnpm dev`) является **обязательной** или **настоятельно рекомендуемой** для корректного применения изменений и предотвращения трудноуловимых ошибок.

---

### 1. Обязательная перезагрузка сервера

В этих случаях изменения **не будут** применены корректно до тех пор, пока вы не перезапустите сервер.

#### ✅ **Изменение переменных окружения**
- **Файлы:** `.env`, `.env.local`, `.env.production` и т.д.
- **Причина:** Сервер Node.js считывает переменные окружения только один раз в момент своего запуска. Любые добавления, удаления или изменения в этих файлах требуют перезагрузки.

#### ✅ **Изменение ключевых конфигурационных файлов**
- **Файлы:** `next.config.ts`, `tsconfig.json`, `tailwind.config.ts`, `postcss.config.mjs`.
- **Причина:** Эти файлы определяют, как ваш проект собирается, запускается и обрабатывает код. Next.js и связанные с ним инструменты (TypeScript, PostCSS) читают их при старте для конфигурации всего процесса сборки.

#### ✅ **Работа с зависимостями**
- **Действия:** Установка, обновление или удаление любых пакетов (например, `pnpm add`, `pnpm remove`, `pnpm install`).
- **Причина:** Структура папки `node_modules` изменяется. Сервер должен заново прочитать и загрузить в память новые или обновленные зависимости.

---

### 2. Настоятельно рекомендуемая перезагрузка

Здесь HMR может сработать, но высок риск столкнуться с непредсказуемым поведением, кэшированием старого кода или труднодиагностируемыми ошибками.

#### ⚠️ **Изменение Middleware**
- **Файл:** `middleware.ts`.
- **Причина:** Middleware — это низкоуровневый код, который выполняется на сервере перед обработкой большинства запросов. Его обновление "на лету" может быть нестабильным. Чтобы гарантировать, что новая логика применяется ко всем последующим запросам корректно, лучше перезапуститься.

#### ⚠️ **Комплексные изменения серверного кода**
- **Файлы:** Глубокие изменения в файлах, импортируемых во многих местах на серверной стороне (например, `lib/db.ts`, `lib/auth.ts`, корневой `data.ts`).
- **Причина:** Иногда HMR может не суметь правильно отследить всю цепочку зависимостей, особенно если изменения затрагивают экспорт/импорт или логику, которая кэшируется.

#### ⚠️ **После необъяснимых ошибок**
- **Ситуация:** Вы сталкиваетесь с ошибкой, которая, кажется, не имеет логической причины (например, "Module not found", хотя файл на месте, или данные приходят в старом формате).
- **Причина:** Это часто признак того, что HMR "запутался" и использует устаревшую версию модуля из кэша. Перезагрузка очищает этот кэш.

---

### 3. Когда перезагрузка обычно не требуется

В этих случаях HMR почти всегда работает безупречно, и вы можете положиться на него.

- **Изменение UI компонентов:** Правки в JSX/TSX внутри `app/`, `src/components/` и т.д.
- **Изменение стилей:** Редактирование CSS-файлов или использование утилитных классов Tailwind.
- **Небольшие правки в API Routes:** Локальные изменения в логике `route.ts`.

---

### Золотое правило

> **Если сомневаешься — перезапусти.**

Перезагрузка сервера занимает всего несколько секунд, но может сэкономить часы отладки из-за проблем с кэшем или некорректно примененными изменениями. 